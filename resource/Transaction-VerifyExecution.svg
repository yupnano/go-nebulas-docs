<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1145.1px" preserveAspectRatio="none" style="width:711px;height:1145px;" version="1.1" viewBox="0 0 711 1145" width="711.7px" zoomAndPan="magnify"><defs><filter height="300%" id="fykziy4wrk8vp" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.200000047683716"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.400000095367432" dy="4.400000095367432" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><ellipse cx="193.05" cy="22" fill="#000000" filter="url(#fykziy4wrk8vp)" rx="11" ry="11" style="stroke: none; stroke-width: 1.100000023841858;"/><rect fill="#FFFFFF" filter="url(#fykziy4wrk8vp)" height="237.1859" style="stroke: #000000; stroke-width: 2.200000047683716;" width="673.2" x="26.95" y="44.6338"/><path d="M326.15,45.7338 L326.15,57.9659 L315.15,68.9659 L26.95,68.9659 " fill="none" style="stroke: #000000; stroke-width: 2.200000047683716;"/><text fill="#000000" font-family="sans-serif" font-size="15.4" lengthAdjust="spacingAndGlyphs" textLength="288.2" x="30.25" y="63.3821">基础检查，如有错误直接丢弃tx，不会上链</text><rect fill="#FEFECE" filter="url(#fykziy4wrk8vp)" height="64.0643" rx="13.75" ry="13.75" style="stroke: #A80036; stroke-width: 1.6500000357627869;" width="237.6" x="74.25" y="87.6659"/><text fill="#000000" font-family="sans-serif" font-size="17.6" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="100.1" x="85.25" y="118.8355">[1] 检查余额</text><text fill="#000000" font-family="sans-serif" font-size="13.2" lengthAdjust="spacingAndGlyphs" textLength="215.6" x="85.25" y="137.8298">check balance &gt; gasLimit*GasPrice</text><path d="M370.15,190.2302 L370.15,220.6249 L348.15,225.0249 L370.15,229.4249 L370.15,259.8197 A0,0 0 0 0 370.15,259.8197 L689.15,259.8197 A0,0 0 0 0 689.15,259.8197 L689.15,201.2302 L678.15,190.2302 L370.15,190.2302 A0,0 0 0 0 370.15,190.2302 " fill="#FBFB77" filter="url(#fykziy4wrk8vp)" style="stroke: #A80036; stroke-width: 1.100000023841858;"/><path d="M678.15,190.2302 L678.15,201.2302 L689.15,201.2302 L678.15,190.2302 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.100000023841858;"/><text fill="#000000" font-family="sans-serif" font-size="14.3" lengthAdjust="spacingAndGlyphs" textLength="255.2" x="376.75" y="212.1179">txBaseGas是每个transaction的基本gas,</text><text fill="#000000" font-family="sans-serif" font-size="14.3" lengthAdjust="spacingAndGlyphs" textLength="295.9" x="376.75" y="231.6478">包括20000/笔的基本资费+ payload长度的费用.</text><text fill="#000000" font-family="sans-serif" font-size="14.3" lengthAdjust="spacingAndGlyphs" textLength="129.8" x="381.15" y="251.1776">= 20000 + length * 1</text><rect fill="#FEFECE" filter="url(#fykziy4wrk8vp)" height="64.0643" rx="13.75" ry="13.75" style="stroke: #A80036; stroke-width: 1.6500000357627869;" width="310.2" x="37.95" y="192.9928"/><text fill="#000000" font-family="sans-serif" font-size="17.6" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="288.2" x="48.95" y="224.1623">[2]检查gasLimit是否足够tx基本gas</text><text fill="#000000" font-family="sans-serif" font-size="13.2" lengthAdjust="spacingAndGlyphs" textLength="179.3" x="48.95" y="243.1567">check gasLimit &gt;= txBaseGas</text><rect fill="#FFFFFF" filter="url(#fykziy4wrk8vp)" height="795.56" style="stroke: #000000; stroke-width: 2.200000047683716;" width="635.8" x="11" y="293.4535"/><path d="M335.5,294.5535 L335.5,327.8177 L324.5,338.8177 L11,338.8177 " fill="none" style="stroke: #000000; stroke-width: 2.200000047683716;"/><text fill="#000000" font-family="sans-serif" font-size="15.4" lengthAdjust="spacingAndGlyphs" textLength="200.2" x="14.3" y="312.2018">执行到这里之后就会上链了。</text><text fill="#000000" font-family="sans-serif" font-size="15.4" lengthAdjust="spacingAndGlyphs" textLength="313.5" x="14.3" y="333.2339">如果某一步出错就会记录相应的execute_Error</text><rect fill="#FEFECE" filter="url(#fykziy4wrk8vp)" height="64.0643" rx="13.75" ry="13.75" style="stroke: #A80036; stroke-width: 1.6500000357627869;" width="222.2" x="81.95" y="357.5177"/><text fill="#000000" font-family="sans-serif" font-size="17.6" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="200.2" x="92.95" y="388.6873">[3]检查payload是否合法</text><text fill="#000000" font-family="sans-serif" font-size="13.2" lengthAdjust="spacingAndGlyphs" textLength="116.6" x="92.95" y="407.6816">check payload vaild</text><path d="M369.6,466.3331 L369.6,496.7279 L347.6,501.1279 L369.6,505.5279 L369.6,535.9226 A0,0 0 0 0 369.6,535.9226 L600.6,535.9226 A0,0 0 0 0 600.6,535.9226 L600.6,477.3331 L589.6,466.3331 L369.6,466.3331 A0,0 0 0 0 369.6,466.3331 " fill="#FBFB77" filter="url(#fykziy4wrk8vp)" style="stroke: #A80036; stroke-width: 1.100000023841858;"/><path d="M589.6,466.3331 L589.6,477.3331 L600.6,477.3331 L589.6,466.3331 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.100000023841858;"/><text fill="#000000" font-family="sans-serif" font-size="14.3" lengthAdjust="spacingAndGlyphs" textLength="166.1" x="376.2" y="488.2209">对于binary, txTypeGas=0;</text><text fill="#000000" font-family="sans-serif" font-size="14.3" lengthAdjust="spacingAndGlyphs" textLength="203.5" x="376.2" y="507.7507">对于call/deploy, txTypeGas=60,</text><text fill="#000000" font-family="sans-serif" font-size="14.3" lengthAdjust="spacingAndGlyphs" textLength="132" x="376.2" y="527.2806">作为启动NVM的消耗</text><rect fill="#FEFECE" filter="url(#fykziy4wrk8vp)" height="82.0918" rx="13.75" ry="13.75" style="stroke: #A80036; stroke-width: 1.6500000357627869;" width="309.1" x="38.5" y="460.082"/><text fill="#000000" font-family="sans-serif" font-size="17.6" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="287.1" x="49.5" y="491.2515">[4]计算payload类型的基本gas消耗</text><text fill="#000000" font-family="sans-serif" font-size="13.2" lengthAdjust="spacingAndGlyphs" textLength="213.4" x="49.5" y="510.2459">gasUsed = txBaseGas + txTypeGas</text><text fill="#000000" font-family="sans-serif" font-size="13.2" lengthAdjust="spacingAndGlyphs" textLength="161.7" x="49.5" y="528.2734">check gasLimit &gt; gasUsed</text><rect fill="#FEFECE" filter="url(#fykziy4wrk8vp)" height="82.0918" rx="13.75" ry="13.75" style="stroke: #A80036; stroke-width: 1.6500000357627869;" width="342.1" x="22" y="580.6738"/><text fill="#000000" font-family="sans-serif" font-size="17.6" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="320.1" x="33" y="611.8433">[5]检查账户余额是否足够，并执行转账</text><text fill="#000000" font-family="sans-serif" font-size="13.2" lengthAdjust="spacingAndGlyphs" textLength="238.7" x="33" y="630.8377">balance &gt;= gasPrice * gasLimit + value.</text><text fill="#000000" font-family="sans-serif" font-size="13.2" lengthAdjust="spacingAndGlyphs" textLength="111.1" x="33" y="648.8652">then transfer value</text><rect fill="#FEFECE" filter="url(#fykziy4wrk8vp)" height="82.0918" rx="13.75" ry="13.75" style="stroke: #A80036; stroke-width: 1.6500000357627869;" width="298.1" x="44" y="701.2656"/><text fill="#000000" font-family="sans-serif" font-size="17.6" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="276.1" x="55" y="732.4351">[6]计算可用于执行合约的gas余额</text><text fill="#000000" font-family="sans-serif" font-size="13.2" lengthAdjust="spacingAndGlyphs" textLength="251.9" x="55" y="751.4295">contractLimitedGas = gasLimit - gasUsed</text><text fill="#000000" font-family="sans-serif" font-size="13.2" lengthAdjust="spacingAndGlyphs" textLength="118.8" x="55" y="769.457">判断余额是否大于零</text><rect fill="#FEFECE" filter="url(#fykziy4wrk8vp)" height="46.0367" rx="13.75" ry="13.75" style="stroke: #A80036; stroke-width: 1.6500000357627869;" width="117.7" x="134.2" y="821.8574"/><text fill="#000000" font-family="sans-serif" font-size="17.6" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="95.7" x="145.2" y="853.0269">[7]执行合约</text><path d="M328.9,922.4102 L328.9,943.04 L306.9,947.44 L328.9,951.84 L328.9,972.4698 A0,0 0 0 0 328.9,972.4698 L635.8,972.4698 A0,0 0 0 0 635.8,972.4698 L635.8,933.4102 L624.8,922.4102 L328.9,922.4102 A0,0 0 0 0 328.9,922.4102 " fill="#FBFB77" filter="url(#fykziy4wrk8vp)" style="stroke: #A80036; stroke-width: 1.100000023841858;"/><path d="M624.8,922.4102 L624.8,933.4102 L635.8,933.4102 L624.8,922.4102 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.100000023841858;"/><text fill="#000000" font-family="sans-serif" font-size="14.3" lengthAdjust="spacingAndGlyphs" textLength="113.3" x="335.5" y="944.2979">统计全部gas消耗,</text><text fill="#000000" font-family="sans-serif" font-size="14.3" lengthAdjust="spacingAndGlyphs" textLength="283.8" x="335.5" y="963.8278">包括 基本gas + 交易类型Gas + 合约执行gas</text><rect fill="#FEFECE" filter="url(#fykziy4wrk8vp)" height="82.0918" rx="13.75" ry="13.75" style="stroke: #A80036; stroke-width: 1.6500000357627869;" width="227.7" x="79.2" y="906.3941"/><text fill="#000000" font-family="sans-serif" font-size="17.6" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170.5" x="90.2" y="937.5636">[8]计算全部gas消耗:</text><text fill="#000000" font-family="sans-serif" font-size="13.2" lengthAdjust="spacingAndGlyphs" textLength="205.7" x="90.2" y="956.558">allGas = gasUsed + gasExecution</text><text fill="#000000" font-family="sans-serif" font-size="13.2" lengthAdjust="spacingAndGlyphs" textLength="145.2" x="90.2" y="974.5855">check gasLimit &gt; allGas</text><rect fill="#FEFECE" filter="url(#fykziy4wrk8vp)" height="40.0275" rx="13.75" ry="13.75" style="stroke: #A80036; stroke-width: 1.6500000357627869;" width="107.8" x="139.15" y="1026.9859"/><text fill="#000000" font-family="sans-serif" font-size="13.2" lengthAdjust="spacingAndGlyphs" textLength="85.8" x="150.15" y="1053.1131">execution over</text><ellipse cx="193.05" cy="1122.0135" fill="none" filter="url(#fykziy4wrk8vp)" rx="11" ry="11" style="stroke: #000000; stroke-width: 1.100000023841858;"/><ellipse cx="193.6" cy="1122.5635" fill="#000000" filter="url(#fykziy4wrk8vp)" rx="6.6" ry="6.6" style="stroke: none; stroke-width: 1.100000023841858;"/><line style="stroke: #A80036; stroke-width: 1.6500000357627869;" x1="193.05" x2="193.05" y1="151.7302" y2="192.9928"/><polygon fill="#A80036" points="188.65,181.9928,193.05,192.9928,197.45,181.9928,193.05,186.3928" style="stroke: #A80036; stroke-width: 1.100000023841858;"/><line style="stroke: #A80036; stroke-width: 1.6500000357627869;" x1="193.05" x2="193.05" y1="33" y2="87.6659"/><polygon fill="#A80036" points="188.65,76.6659,193.05,87.6659,197.45,76.6659,193.05,81.0659" style="stroke: #A80036; stroke-width: 1.100000023841858;"/><line style="stroke: #A80036; stroke-width: 1.6500000357627869;" x1="193.05" x2="193.05" y1="421.582" y2="460.082"/><polygon fill="#A80036" points="188.65,449.082,193.05,460.082,197.45,449.082,193.05,453.482" style="stroke: #A80036; stroke-width: 1.100000023841858;"/><line style="stroke: #A80036; stroke-width: 1.6500000357627869;" x1="193.05" x2="193.05" y1="542.1738" y2="580.6738"/><polygon fill="#A80036" points="188.65,569.6738,193.05,580.6738,197.45,569.6738,193.05,574.0738" style="stroke: #A80036; stroke-width: 1.100000023841858;"/><line style="stroke: #A80036; stroke-width: 1.6500000357627869;" x1="193.05" x2="193.05" y1="662.7656" y2="701.2656"/><polygon fill="#A80036" points="188.65,690.2656,193.05,701.2656,197.45,690.2656,193.05,694.6656" style="stroke: #A80036; stroke-width: 1.100000023841858;"/><line style="stroke: #A80036; stroke-width: 1.6500000357627869;" x1="193.05" x2="193.05" y1="783.3574" y2="821.8574"/><polygon fill="#A80036" points="188.65,810.8574,193.05,821.8574,197.45,810.8574,193.05,815.2574" style="stroke: #A80036; stroke-width: 1.100000023841858;"/><line style="stroke: #A80036; stroke-width: 1.6500000357627869;" x1="193.05" x2="193.05" y1="867.8941" y2="906.3941"/><polygon fill="#A80036" points="188.65,895.3941,193.05,906.3941,197.45,895.3941,193.05,899.7941" style="stroke: #A80036; stroke-width: 1.100000023841858;"/><line style="stroke: #A80036; stroke-width: 1.6500000357627869;" x1="193.05" x2="193.05" y1="988.4859" y2="1026.9859"/><polygon fill="#A80036" points="188.65,1015.9859,193.05,1026.9859,197.45,1015.9859,193.05,1020.3859" style="stroke: #A80036; stroke-width: 1.100000023841858;"/><line style="stroke: #A80036; stroke-width: 1.6500000357627869;" x1="193.05" x2="193.05" y1="257.0571" y2="357.5177"/><polygon fill="#A80036" points="188.65,346.5177,193.05,357.5177,197.45,346.5177,193.05,350.9177" style="stroke: #A80036; stroke-width: 1.100000023841858;"/><line style="stroke: #A80036; stroke-width: 1.6500000357627869;" x1="193.05" x2="193.05" y1="1067.0135" y2="1111.0135"/><polygon fill="#A80036" points="188.65,1100.0135,193.05,1111.0135,197.45,1100.0135,193.05,1104.4135" style="stroke: #A80036; stroke-width: 1.100000023841858;"/><!--
@startuml

start;

  partition 基础检查，如有错误直接丢弃tx，不会上链 {
  :=[1] 检查余额
  check balance > gasLimit*GasPrice;

  :=[2]检查gasLimit是否足够tx基本gas
  check gasLimit >= txBaseGas;
      note right
        txBaseGas是每个transaction的基本gas,
        包括20000/笔的基本资费+ payload长度的费用.
         = 20000 + length * 1
      end note

  }

  partition 执行到这里之后就会上链了。\n如果某一步出错就会记录相应的execute_Error {
  :=[3]检查payload是否合法
  check payload vaild;

  :=[4]计算payload类型的基本gas消耗
  gasUsed = txBaseGas + txTypeGas
  check gasLimit > gasUsed;
      note right
        对于binary, txTypeGas=0;
        对于call/deploy, txTypeGas=60, 
        作为启动NVM的消耗
      end note

  :=[5]检查账户余额是否足够，并执行转账
  balance >= gasPrice * gasLimit + value.
  then transfer value;

  :=[6]计算可用于执行合约的gas余额
  contractLimitedGas = gasLimit - gasUsed
  判断余额是否大于零;

  :=[7]执行合约;

  :=[8]计算全部gas消耗:
  allGas = gasUsed + gasExecution
  check gasLimit > allGas;
      note right
        统计全部gas消耗,
        包括 基本gas + 交易类型Gas + 合约执行gas
      end note

  :execution over;

  }

stop

@enduml

PlantUML version 1.2018.01(Mon Jan 29 02:08:22 CST 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_152-release-1136-b39
Operating System: Windows 10
OS Version: 10.0
Default Encoding: GBK
Language: zh
Country: CN
--></g></svg>