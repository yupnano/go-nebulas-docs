<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1346.8px" preserveAspectRatio="none" style="width:945px;height:1346px;" version="1.1" viewBox="0 0 945 1346" width="945.1px" zoomAndPan="magnify"><defs><filter height="300%" id="fckmawu5qejr6" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.5999999046325684"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="5.199999809265137" dy="5.199999809265137" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><ellipse cx="219.7" cy="26" fill="#000000" filter="url(#fckmawu5qejr6)" rx="13" ry="13" style="stroke: none; stroke-width: 1.2999999523162842;"/><rect fill="#FFFFFF" filter="url(#fckmawu5qejr6)" height="296.2895" style="stroke: #000000; stroke-width: 2.5999999046325684;" width="865.15" x="66.3" y="52.749"/><path d="M419.9,54.049 L419.9,68.5052 L406.9,81.5052 L66.3,81.5052 " fill="none" style="stroke: #000000; stroke-width: 2.5999999046325684;"/><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacingAndGlyphs" textLength="340.6" x="70.2" y="74.9061">基础检查，如有错误直接丢弃tx，不会上链</text><rect fill="#FEFECE" filter="url(#fckmawu5qejr6)" height="68.6105" rx="16.25" ry="16.25" style="stroke: #A80036; stroke-width: 1.9499999284744263;" width="280.8" x="79.3" y="103.6052"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacingAndGlyphs" textLength="62.4" x="92.3" y="134.4827">检查余额</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacingAndGlyphs" textLength="254.8" x="92.3" y="155.788">check balance &gt; gasLimit*GasPrice</text><path d="M371.15,217.7157 L371.15,265.1771 L345.15,270.3771 L371.15,275.5771 L371.15,323.0386 A0,0 0 0 0 371.15,323.0386 L918.45,323.0386 A0,0 0 0 0 918.45,323.0386 L918.45,230.7157 L905.45,217.7157 L371.15,217.7157 A0,0 0 0 0 371.15,217.7157 " fill="#FBFB77" filter="url(#fckmawu5qejr6)" style="stroke: #A80036; stroke-width: 1.2999999523162842;"/><path d="M905.45,217.7157 L905.45,230.7157 L918.45,230.7157 L905.45,217.7157 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.2999999523162842;"/><text fill="#000000" font-family="sans-serif" font-size="16.9" lengthAdjust="spacingAndGlyphs" textLength="301.6" x="378.95" y="243.583">txBaseGas是每个transaction的基本gas,</text><text fill="#000000" font-family="sans-serif" font-size="16.9" lengthAdjust="spacingAndGlyphs" textLength="349.7" x="378.95" y="266.6638">包括20000/笔的基本资费+ payload长度的费用.</text><text fill="#000000" font-family="sans-serif" font-size="16.9" lengthAdjust="spacingAndGlyphs" textLength="514.8" x="384.15" y="289.7445">= MinGasCountPerTransaction + payloadLength * GasCountPerByte</text><text fill="#000000" font-family="sans-serif" font-size="16.9" lengthAdjust="spacingAndGlyphs" textLength="153.4" x="384.15" y="312.8252">= 20000 + length * 1</text><rect fill="#FEFECE" filter="url(#fckmawu5qejr6)" height="68.6105" rx="16.25" ry="16.25" style="stroke: #A80036; stroke-width: 1.9499999284744263;" width="250.9" x="94.25" y="236.0719"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacingAndGlyphs" textLength="224.9" x="107.25" y="266.9494">检查gasLimit是否足够tx基本gas</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacingAndGlyphs" textLength="211.9" x="107.25" y="288.2547">check gasLimit &gt;= txBaseGas</text><rect fill="#FFFFFF" filter="url(#fckmawu5qejr6)" height="918.9019" style="stroke: #000000; stroke-width: 2.5999999046325684;" width="821.6" x="13" y="362.7876"/><path d="M396.5,364.0876 L396.5,403.3999 L383.5,416.3999 L13,416.3999 " fill="none" style="stroke: #000000; stroke-width: 2.5999999046325684;"/><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacingAndGlyphs" textLength="236.6" x="16.9" y="384.9447">执行到这里之后就会上链了。</text><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacingAndGlyphs" textLength="370.5" x="16.9" y="409.8009">如果某一步出错就会记录相应的execute_Error</text><rect fill="#FEFECE" filter="url(#fckmawu5qejr6)" height="68.6105" rx="16.25" ry="16.25" style="stroke: #A80036; stroke-width: 1.9499999284744263;" width="175.5" x="131.95" y="438.4999"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacingAndGlyphs" textLength="149.5" x="144.95" y="469.3774">检查payload是否有错</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacingAndGlyphs" textLength="137.8" x="144.95" y="490.6827">check payload vaild</text><path d="M392.6,578.6403 L392.6,603.021 L366.6,608.221 L392.6,613.421 L392.6,637.8017 A0,0 0 0 0 392.6,637.8017 L821.6,637.8017 A0,0 0 0 0 821.6,637.8017 L821.6,591.6403 L808.6,578.6403 L392.6,578.6403 A0,0 0 0 0 392.6,578.6403 " fill="#FBFB77" filter="url(#fckmawu5qejr6)" style="stroke: #A80036; stroke-width: 1.2999999523162842;"/><path d="M808.6,578.6403 L808.6,591.6403 L821.6,591.6403 L808.6,578.6403 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.2999999523162842;"/><text fill="#000000" font-family="sans-serif" font-size="16.9" lengthAdjust="spacingAndGlyphs" textLength="196.3" x="400.4" y="604.5076">对于binary, txTypeGas=0;</text><text fill="#000000" font-family="sans-serif" font-size="16.9" lengthAdjust="spacingAndGlyphs" textLength="401.7" x="400.4" y="627.5883">对于call/deploy, txTypeGas=60, 作为启动NVM的消耗</text><rect fill="#FEFECE" filter="url(#fckmawu5qejr6)" height="111.2211" rx="16.25" ry="16.25" style="stroke: #A80036; stroke-width: 1.9499999284744263;" width="293.8" x="72.8" y="552.6104"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacingAndGlyphs" textLength="267.8" x="85.8" y="583.488">calculate payloadBaseGas of payload</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacingAndGlyphs" textLength="223.6" x="85.8" y="604.7932">计算payload类型的基本gas消耗</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacingAndGlyphs" textLength="252.2" x="85.8" y="626.0985">gasUsed = txBaseGas + txTypeGas</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacingAndGlyphs" textLength="191.1" x="85.8" y="647.4038">check gasLimit &gt; gasUsed</text><rect fill="#FEFECE" filter="url(#fckmawu5qejr6)" height="89.9158" rx="16.25" ry="16.25" style="stroke: #A80036; stroke-width: 1.9499999284744263;" width="308.1" x="65.65" y="709.3315"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacingAndGlyphs" textLength="249.6" x="78.65" y="740.2091">检查账户余额是否足够，并执行转账</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacingAndGlyphs" textLength="282.1" x="78.65" y="761.5143">balance &gt;= gasPrice * gasLimit + value.</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacingAndGlyphs" textLength="131.3" x="78.65" y="782.8196">then transfer value</text><rect fill="#FEFECE" filter="url(#fckmawu5qejr6)" height="89.9158" rx="16.25" ry="16.25" style="stroke: #A80036; stroke-width: 1.9499999284744263;" width="387.4" x="26" y="844.7473"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacingAndGlyphs" textLength="361.4" x="39" y="875.6249">计算可用于执行合约的gas余额: contractLimitedGas</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacingAndGlyphs" textLength="297.7" x="39" y="896.9301">contractLimitedGas = gasLimit - gasUsed</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacingAndGlyphs" textLength="140.4" x="39" y="918.2354">判断余额是否大于零</text><rect fill="#FEFECE" filter="url(#fckmawu5qejr6)" height="47.3053" rx="16.25" ry="16.25" style="stroke: #A80036; stroke-width: 1.9499999284744263;" width="140.4" x="149.5" y="980.1631"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacingAndGlyphs" textLength="114.4" x="162.5" y="1011.0407">execute contract</text><path d="M380.25,1088.3456 L380.25,1112.7263 L354.25,1117.9263 L380.25,1123.1263 L380.25,1147.507 A0,0 0 0 0 380.25,1147.507 L742.95,1147.507 A0,0 0 0 0 742.95,1147.507 L742.95,1101.3456 L729.95,1088.3456 L380.25,1088.3456 A0,0 0 0 0 380.25,1088.3456 " fill="#FBFB77" filter="url(#fckmawu5qejr6)" style="stroke: #A80036; stroke-width: 1.2999999523162842;"/><path d="M729.95,1088.3456 L729.95,1101.3456 L742.95,1101.3456 L729.95,1088.3456 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.2999999523162842;"/><text fill="#000000" font-family="sans-serif" font-size="16.9" lengthAdjust="spacingAndGlyphs" textLength="133.9" x="388.05" y="1114.2129">统计全部gas消耗,</text><text fill="#000000" font-family="sans-serif" font-size="16.9" lengthAdjust="spacingAndGlyphs" textLength="335.4" x="388.05" y="1137.2937">包括 基本gas + 交易类型Gas + 合约执行gas</text><rect fill="#FEFECE" filter="url(#fckmawu5qejr6)" height="89.9158" rx="16.25" ry="16.25" style="stroke: #A80036; stroke-width: 1.9499999284744263;" width="269.1" x="85.15" y="1072.9684"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacingAndGlyphs" textLength="132.6" x="98.15" y="1103.846">calculate final gas:</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacingAndGlyphs" textLength="243.1" x="98.15" y="1125.1512">allGas = gasUsed + gasExecution</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacingAndGlyphs" textLength="171.6" x="98.15" y="1146.4565">check gasLimit &gt; allGas</text><rect fill="#FEFECE" filter="url(#fckmawu5qejr6)" height="47.3053" rx="16.25" ry="16.25" style="stroke: #A80036; stroke-width: 1.9499999284744263;" width="127.4" x="156" y="1208.3842"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacingAndGlyphs" textLength="101.4" x="169" y="1239.2618">execution over</text><ellipse cx="219.7" cy="1320.6895" fill="none" filter="url(#fckmawu5qejr6)" rx="13" ry="13" style="stroke: #000000; stroke-width: 1.2999999523162842;"/><ellipse cx="220.35" cy="1321.3395" fill="#000000" filter="url(#fckmawu5qejr6)" rx="7.8" ry="7.8" style="stroke: none; stroke-width: 1.2999999523162842;"/><line style="stroke: #A80036; stroke-width: 1.9499999284744263;" x1="219.7" x2="219.7" y1="172.2157" y2="236.0719"/><polygon fill="#A80036" points="214.5,223.0719,219.7,236.0719,224.9,223.0719,219.7,228.2719" style="stroke: #A80036; stroke-width: 1.2999999523162842;"/><line style="stroke: #A80036; stroke-width: 1.9499999284744263;" x1="219.7" x2="219.7" y1="39" y2="103.6052"/><polygon fill="#A80036" points="214.5,90.6052,219.7,103.6052,224.9,90.6052,219.7,95.8052" style="stroke: #A80036; stroke-width: 1.2999999523162842;"/><line style="stroke: #A80036; stroke-width: 1.9499999284744263;" x1="219.7" x2="219.7" y1="507.1104" y2="552.6104"/><polygon fill="#A80036" points="214.5,539.6104,219.7,552.6104,224.9,539.6104,219.7,544.8104" style="stroke: #A80036; stroke-width: 1.2999999523162842;"/><line style="stroke: #A80036; stroke-width: 1.9499999284744263;" x1="219.7" x2="219.7" y1="663.8315" y2="709.3315"/><polygon fill="#A80036" points="214.5,696.3315,219.7,709.3315,224.9,696.3315,219.7,701.5315" style="stroke: #A80036; stroke-width: 1.2999999523162842;"/><line style="stroke: #A80036; stroke-width: 1.9499999284744263;" x1="219.7" x2="219.7" y1="799.2473" y2="844.7473"/><polygon fill="#A80036" points="214.5,831.7473,219.7,844.7473,224.9,831.7473,219.7,836.9473" style="stroke: #A80036; stroke-width: 1.2999999523162842;"/><line style="stroke: #A80036; stroke-width: 1.9499999284744263;" x1="219.7" x2="219.7" y1="934.6631" y2="980.1631"/><polygon fill="#A80036" points="214.5,967.1631,219.7,980.1631,224.9,967.1631,219.7,972.3631" style="stroke: #A80036; stroke-width: 1.2999999523162842;"/><line style="stroke: #A80036; stroke-width: 1.9499999284744263;" x1="219.7" x2="219.7" y1="1027.4684" y2="1072.9684"/><polygon fill="#A80036" points="214.5,1059.9684,219.7,1072.9684,224.9,1059.9684,219.7,1065.1684" style="stroke: #A80036; stroke-width: 1.2999999523162842;"/><line style="stroke: #A80036; stroke-width: 1.9499999284744263;" x1="219.7" x2="219.7" y1="1162.8842" y2="1208.3842"/><polygon fill="#A80036" points="214.5,1195.3842,219.7,1208.3842,224.9,1195.3842,219.7,1200.5842" style="stroke: #A80036; stroke-width: 1.2999999523162842;"/><line style="stroke: #A80036; stroke-width: 1.9499999284744263;" x1="219.7" x2="219.7" y1="304.6824" y2="438.4999"/><polygon fill="#A80036" points="214.5,425.4999,219.7,438.4999,224.9,425.4999,219.7,430.6999" style="stroke: #A80036; stroke-width: 1.2999999523162842;"/><line style="stroke: #A80036; stroke-width: 1.9499999284744263;" x1="219.7" x2="219.7" y1="1255.6895" y2="1307.6895"/><polygon fill="#A80036" points="214.5,1294.6895,219.7,1307.6895,224.9,1294.6895,219.7,1299.8895" style="stroke: #A80036; stroke-width: 1.2999999523162842;"/><!--
@startuml

start;

  partition 基础检查，如有错误直接丢弃tx，不会上链 {
  :检查余额
  check balance > gasLimit*GasPrice;

  :检查gasLimit是否足够tx基本gas
  check gasLimit >= txBaseGas;
      note right
        txBaseGas是每个transaction的基本gas,
        包括20000/笔的基本资费+ payload长度的费用.
         = MinGasCountPerTransaction + payloadLength * GasCountPerByte
         = 20000 + length * 1
      end note

  }

  partition 执行到这里之后就会上链了。\n如果某一步出错就会记录相应的execute_Error {
  :检查payload是否有错
  check payload vaild;

  :calculate payloadBaseGas of payload
  计算payload类型的基本gas消耗
  gasUsed = txBaseGas + txTypeGas
  check gasLimit > gasUsed;
      note right
        对于binary, txTypeGas=0;
        对于call/deploy, txTypeGas=60, 作为启动NVM的消耗
      end note

  :检查账户余额是否足够，并执行转账
  balance >= gasPrice * gasLimit + value.
  then transfer value;

  :计算可用于执行合约的gas余额: contractLimitedGas
  contractLimitedGas = gasLimit - gasUsed
  判断余额是否大于零;

  :execute contract;

  :calculate final gas:
  allGas = gasUsed + gasExecution
  check gasLimit > allGas;
      note right
        统计全部gas消耗,
        包括 基本gas + 交易类型Gas + 合约执行gas
      end note

  :execution over;

  }

stop

@enduml

PlantUML version 1.2018.01(Mon Jan 29 02:08:22 CST 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_152-release-1136-b39
Operating System: Windows 10
OS Version: 10.0
Default Encoding: GBK
Language: zh
Country: CN
--></g></svg>